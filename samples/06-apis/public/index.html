<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"/>
    <title>DevFest: Web Standards 2017</title>
    <link rel="icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json"> 
    <style>
      body,
      html{
          margin: 0;
          padding: 0;
          background-color: black;
          overflow: hidden;
      }

      body, #canvas {
        width:100%; 
        height:100%; 
        margin:0px;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" 
    oncontextmenu="event.preventDefault()">
    </canvas>

    <script type='text/javascript'>
      var Module = {
        canvas: (() => {
          const canvas = document.getElementById('canvas');
          canvas.addEventListener("webglcontextlost", (e) => { 
            alert('WebGL context lost. You will need to reload the page.'); 
            e.preventDefault(); 
          }, false);
          return canvas;
        })(),
        setStatus: (status) => { 
          console.log(status); 
        }
      };
    </script>   
    <script async type="text/javascript" src="webassembly.js"></script>
    <script>
        (async function(){
          if ('serviceWorker' in navigator) {
            try{
              const reg = await navigator.serviceWorker.register('/service-worker.js');
              console.log('Service Worker has been registered!');
            }catch(err){
              console.log('Service worker registration failed:', err);
            }
          }
        })();
    </script> 
    <script>
    if (navigator.credentials && navigator.credentials.preventSilentAccess) {
      navigator.credentials.get({
        password: true,
        mediation: 'optional'
      }).then(cred => {
        if(!cred){
          cred = new PasswordCredential({
          id:       'spugachev@gmail.com',
          name:     'Sergey Pugachev',
          password: 'Hello!',
          iconURL:  'https://lh3.googleusercontent.com/-KFIgYAXzcl8/AAAAAAAAAAI/AAAAAAAAAAA/APJypA1dbRV9tq9gGjj8-2Wh65JIEeV-Dg/mo/photo.jpg?sz=64'
          });

          navigator.credentials.store(cred);
        }

        console.log(cred);
      }).catch((err) => {
        console.log(err);
      });    
    }
    </script>
    <script>
      return;
      const canvas = document.getElementById('canvas');
      canvas.addEventListener('touchend', doPayment);
      canvas.addEventListener('click', doPayment);

      async function doPayment(){
        const creditCardPaymentMethod = {  
          supportedMethods: ['basic-card'],  
          data: {  
            supportedNetworks: ['visa', 'mastercard', 'amex'],  
            supportedTypes: ['credit', 'debit'],  
          },  
        };

        const paymentDetails = {  
          total: {  
            label: '1-year Pro Subscription',  
            amount: {  
              currency: 'RUB',  
              value: '1999',  
            },  
          }, 
          displayItems: [  
          {  
            label: 'Subtotal',  
            amount: {  
              currency: 'RUB',  
              value: '4999',  
            },  
          }, {  
            label: 'Discount',  
            amount: {  
              currency: 'RUB',  
              value: '-3000',  
            },  
          } 
          ] 
        };

        let request = new PaymentRequest([creditCardPaymentMethod], paymentDetails, { 
          requestShipping: false, 
          requestPayerEmail: true, 
          requestPayerPhone: true 
        });

        try{
          const res = await request.show();
          console.log(res);
        }catch(err){
          console.log(err);
        }
      }
    </script>
    <script>
      const canvas = document.getElementById('canvas');
      canvas.addEventListener('touchend', manageCandle);
      canvas.addEventListener('click', manageCandle);

      let encoder = new TextEncoder('utf-8');
      let decoder = new TextDecoder('utf-8');
      const CANDLE_SERVICE_UUID = 0xFF02;
      const CANDLE_DEVICE_NAME_UUID = 0xFFFF;
      const CANDLE_COLOR_UUID = 0xFFFC;
      const CANDLE_EFFECT_UUID = 0xFFFB;
      const CANDLE_BLOW_NOTIFICATIONS_UUID = 0x2A37;

      async function manageCandle(){
        let options = {filters:[{services:[ CANDLE_SERVICE_UUID ]}],
                     optionalServices: ['battery_service']};

        const device = await navigator.bluetooth.requestDevice(options);
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(CANDLE_SERVICE_UUID);
        const effectChar = await service.getCharacteristic(CANDLE_EFFECT_UUID);
        const colorChar = await service.getCharacteristic(CANDLE_COLOR_UUID);

        console.log(device);

        let r = 254;
        let g = 0;
        let b = 0;

        setInterval(async ()=>{
          let data = [0x00, r, g, b, 0x05, 0x00, 0x01, 0x00];
          await effectChar.writeValue(new Uint8Array(data));

          data = [0x00, r, g, b];
          await colorChar.writeValue(new Uint8Array(data));

          r -= 5;
          g += 5;
        }, 100)
      }
    </script>
  </body>
</html>